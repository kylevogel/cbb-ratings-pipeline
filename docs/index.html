<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBB Rankings</title>
    <style>
      body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; margin: 24px; }
      .top { display:flex; align-items:baseline; justify-content:space-between; gap:16px; margin-bottom: 12px; }
      h1 { font-size: 20px; margin: 0; }
      #updated { font-size: 12px; opacity: .75; white-space: nowrap; }
      .controls { display:flex; gap:10px; align-items:center; margin: 10px 0 14px; }
      input { padding: 8px 10px; border: 1px solid #ddd; border-radius: 10px; width: 260px; font-size: 13px; }
      #count { font-size: 12px; opacity: .75; }
      table { border-collapse: collapse; width: 100%; }
      thead th { text-align:left; font-size:12px; letter-spacing:.02em; opacity:.9; border-bottom:1px solid #ddd; padding:10px 8px; position:sticky; top:0; background:#fff; }
      tbody td { border-bottom: 1px solid #f0f0f0; padding: 9px 8px; font-size: 13px; }
      td.num { text-align:right; font-variant-numeric: tabular-nums; }
      td.team { width: 240px; padding-left: 2px; }
      td.record { width: 72px; }
    </style>
  </head>
  <body>
    <div class="top">
      <h1>CBB Rankings Dashboard</h1>
      <div id="updated">Updated: —</div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Search team…" />
      <div id="count"></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th>Record</th>
          <th class="num">Avg of Metrics</th>
          <th class="num">AP</th>
          <th class="num">NET</th>
          <th class="num">KenPom</th>
          <th class="num">BPI</th>
          <th class="num">SoSa</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <script>
      const asNum = (v) => {
        if (v === null || v === undefined) return null;
        const s = String(v).trim();
        if (!s || s.toLowerCase() === "nr" || s.toLowerCase() === "na") return null;
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      };

      const showRankOrNR = (v) => {
        const n = asNum(v);
        return n === null ? "NR" : String(n);
      };

      const render = (rows) => {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="team">${r.Team ?? ""}</td>
            <td class="record">${r.Record ?? ""}</td>
            <td class="num">${r["Avg of Metrics"] ?? "NR"}</td>
            <td class="num">${showRankOrNR(r.AP)}</td>
            <td class="num">${showRankOrNR(r.NET)}</td>
            <td class="num">${showRankOrNR(r.KenPom)}</td>
            <td class="num">${showRankOrNR(r.BPI)}</td>
            <td class="num">${showRankOrNR(r.SoSa)}</td>
          `;
          tbody.appendChild(tr);
        }

        document.getElementById("count").textContent = `${rows.length} teams`;
      };

      let allRows = [];

      const applyFilter = () => {
        const q = document.getElementById("search").value.trim().toLowerCase();
        if (!q) return render(allRows);
        render(allRows.filter((r) => String(r.Team ?? "").toLowerCase().includes(q)));
      };

      document.getElementById("search").addEventListener("input", applyFilter);

      fetch("data/rankings_current.json", { cache: "no-store" })
        .then((r) => r.json())
        .then((data) => {
          document.getElementById("updated").textContent = `Updated: ${data.updated ?? "—"}`;
          allRows = Array.isArray(data.rows) ? data.rows : [];
          render(allRows);
        })
        .catch(() => {
          document.getElementById("updated").textContent = "Updated: (failed to load data)";
        });
    </script>
  </body>
</html>
