<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBB Rankings Dashboard</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        margin: 18px;
        color: #111;
      }
      .topbar {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 12px;
      }
      h1 {
        font-size: 18px;
        margin: 0;
        font-weight: 650;
      }
      .meta {
        font-size: 12px;
        color: #555;
        white-space: nowrap;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0 14px 0;
      }
      input[type="search"] {
        width: 320px;
        max-width: 70vw;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        outline: none;
        font-size: 13px;
      }
      .btn {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #fff;
        font-size: 13px;
        cursor: pointer;
      }
      .wrap {
        border: 1px solid #eee;
        border-radius: 14px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #fafafa;
        border-bottom: 1px solid #eee;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #333;
        padding: 10px 10px;
        cursor: pointer;
        user-select: none;
      }
      tbody td {
        padding: 9px 10px;
        border-bottom: 1px solid #f2f2f2;
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      tbody tr:hover td {
        background: #fcfcfc;
      }
      .col-team { width: 240px; }
      .col-record { width: 80px; }
      .col-ap { width: 60px; }
      .col-avg { width: 70px; }
      .col-net, .col-kenpom, .col-bpi, .col-sos { width: 70px; }

      .num { text-align: right; }
      .left { text-align: left; }

      .sort-ind {
        font-size: 10px;
        color: #777;
        margin-left: 6px;
      }
      .loading {
        font-size: 13px;
        color: #555;
        padding: 12px 2px;
      }
      .error {
        font-size: 13px;
        color: #b00020;
        padding: 12px 2px;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <h1>CBB Rankings Dashboard</h1>
      <div class="meta" id="meta"></div>
    </div>

    <div class="controls">
      <input id="search" type="search" placeholder="Search team…" />
      <button class="btn" id="reset">Reset sort</button>
    </div>

    <div class="wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th class="col-team left" data-key="team" data-type="text">Team<span class="sort-ind" id="ind-team"></span></th>
            <th class="col-record num" data-key="record" data-type="record">Record<span class="sort-ind" id="ind-record"></span></th>
            <th class="col-ap num" data-key="ap" data-type="num">AP<span class="sort-ind" id="ind-ap"></span></th>
            <th class="col-avg num" data-key="avg" data-type="num">AVG<span class="sort-ind" id="ind-avg"></span></th>
            <th class="col-net num" data-key="net" data-type="num">NET<span class="sort-ind" id="ind-net"></span></th>
            <th class="col-kenpom num" data-key="kenpom" data-type="num">KenPom<span class="sort-ind" id="ind-kenpom"></span></th>
            <th class="col-bpi num" data-key="bpi" data-type="num">BPI<span class="sort-ind" id="ind-bpi"></span></th>
            <th class="col-sos num" data-key="sos" data-type="num">SoS<span class="sort-ind" id="ind-sos"></span></th>
          </tr>
        </thead>
        <tbody id="body">
          <tr><td colspan="8" class="loading">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <script>
      const state = {
        rows: [],
        filtered: [],
        sortKey: "avg",
        sortDir: "asc",
        query: ""
      }

      function parseCSV(text) {
        const lines = text.trim().split(/\r?\n/)
        const headers = lines[0].split(",").map(h => h.trim())
        const out = []
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i]
          const cells = []
          let cur = ""
          let inQ = false
          for (let j = 0; j < line.length; j++) {
            const ch = line[j]
            if (ch === '"' ) {
              if (inQ && line[j + 1] === '"') {
                cur += '"'
                j++
              } else {
                inQ = !inQ
              }
            } else if (ch === "," && !inQ) {
              cells.push(cur)
              cur = ""
            } else {
              cur += ch
            }
          }
          cells.push(cur)
          const obj = {}
          headers.forEach((h, idx) => obj[h] = (cells[idx] ?? "").trim())
          out.push(obj)
        }
        return out
      }

      function toNum(v) {
        if (v === null || v === undefined) return null
        const s = String(v).trim()
        if (!s) return null
        const n = Number(s)
        return Number.isFinite(n) ? n : null
      }

      function recordWinPct(rec) {
        const s = String(rec || "").trim()
        const m = s.match(/^(\d+)\-(\d+)$/)
        if (!m) return null
        const w = Number(m[1])
        const l = Number(m[2])
        const g = w + l
        if (!g) return 0
        return w / g
      }

      function cmp(a, b, type) {
        if (type === "num") {
          const x = toNum(a)
          const y = toNum(b)
          if (x === null && y === null) return 0
          if (x === null) return 1
          if (y === null) return -1
          return x - y
        }
        if (type === "record") {
          const x = recordWinPct(a)
          const y = recordWinPct(b)
          if (x === null && y === null) return 0
          if (x === null) return 1
          if (y === null) return -1
          return x - y
        }
        const x = String(a || "").toLowerCase()
        const y = String(b || "").toLowerCase()
        if (!x && !y) return 0
        if (!x) return 1
        if (!y) return -1
        return x < y ? -1 : x > y ? 1 : 0
      }

      function applyFilterAndSort() {
        const q = state.query.toLowerCase().trim()
        const base = q ? state.rows.filter(r => String(r.team || "").toLowerCase().includes(q)) : [...state.rows]
        const key = state.sortKey
        const th = document.querySelector(`th[data-key="${key}"]`)
        const type = th ? th.dataset.type : "text"
        base.sort((r1, r2) => {
          const c = cmp(r1[key], r2[key], type)
          return state.sortDir === "asc" ? c : -c
        })
        state.filtered = base
      }

      function render() {
        const tbody = document.getElementById("body")
        tbody.innerHTML = ""
        for (const r of state.filtered) {
          const tr = document.createElement("tr")

          const tdTeam = document.createElement("td")
          tdTeam.className = "left"
          tdTeam.textContent = r.team || ""
          tr.appendChild(tdTeam)

          const tdRec = document.createElement("td")
          tdRec.className = "num"
          tdRec.textContent = r.record || ""
          tr.appendChild(tdRec)

          const tdAp = document.createElement("td")
          tdAp.className = "num"
          tdAp.textContent = r.ap || ""
          tr.appendChild(tdAp)

          const tdAvg = document.createElement("td")
          tdAvg.className = "num"
          tdAvg.textContent = r.avg || ""
          tr.appendChild(tdAvg)

          const tdNet = document.createElement("td")
          tdNet.className = "num"
          tdNet.textContent = r.net || ""
          tr.appendChild(tdNet)

          const tdKen = document.createElement("td")
          tdKen.className = "num"
          tdKen.textContent = r.kenpom || ""
          tr.appendChild(tdKen)

          const tdBpi = document.createElement("td")
          tdBpi.className = "num"
          tdBpi.textContent = r.bpi || ""
          tr.appendChild(tdBpi)

          const tdSos = document.createElement("td")
          tdSos.className = "num"
          tdSos.textContent = r.sos || ""
          tr.appendChild(tdSos)

          tbody.appendChild(tr)
        }

        document.querySelectorAll(".sort-ind").forEach(x => x.textContent = "")
        const ind = document.getElementById(`ind-${state.sortKey}`)
        if (ind) ind.textContent = state.sortDir === "asc" ? "▲" : "▼"
      }

      function wireSorting() {
        document.querySelectorAll("thead th").forEach(th => {
          th.addEventListener("click", () => {
            const key = th.dataset.key
            if (!key) return
            if (state.sortKey === key) {
              state.sortDir = state.sortDir === "asc" ? "desc" : "asc"
            } else {
              state.sortKey = key
              state.sortDir = "asc"
            }
            applyFilterAndSort()
            render()
          })
        })
      }

      async function load() {
        try {
          const res = await fetch(`rankings.csv?ts=${Date.now()}`)
          if (!res.ok) throw new Error(`HTTP ${res.status}`)
          const text = await res.text()
          const rows = parseCSV(text)

          state.rows = rows.map(r => ({
            team: r.team || "",
            record: r.record || "",
            ap: r.ap || "",
            avg: r.avg || "",
            net: r.net || "",
            kenpom: r.kenpom || "",
            bpi: r.bpi || "",
            sos: r.sos || ""
          }))

          state.query = ""
          state.sortKey = "avg"
          state.sortDir = "asc"

          applyFilterAndSort()
          render()

          try {
            const metaRes = await fetch(`last_updated.csv?ts=${Date.now()}`)
            if (metaRes.ok) {
              const mt = await metaRes.text()
              const mrows = parseCSV(mt)
              const when = mrows[0]?.updated_at_utc || ""
              document.getElementById("meta").textContent = when ? `Last updated: ${when}` : ""
            }
          } catch (e) {
            document.getElementById("meta").textContent = ""
          }
        } catch (e) {
          const tbody = document.getElementById("body")
          tbody.innerHTML = `<tr><td colspan="8" class="error">Failed to load rankings.csv: ${String(e)}</td></tr>`
        }
      }

      document.getElementById("search").addEventListener("input", (ev) => {
        state.query = ev.target.value || ""
        applyFilterAndSort()
        render()
      })

      document.getElementById("reset").addEventListener("click", () => {
        state.sortKey = "avg"
        state.sortDir = "asc"
        state.query = ""
        document.getElementById("search").value = ""
        applyFilterAndSort()
        render()
      })

      wireSorting()
      load()
    </script>
  </body>
</html>
