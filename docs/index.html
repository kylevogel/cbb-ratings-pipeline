<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CBB Rankings Dashboard</title>
    <style>
      :root {
        --bg: #f7f7f8;
        --panel: #ffffff;
        --border: rgba(0, 0, 0, 0.08);
        --text: #111;
        --muted: rgba(0, 0, 0, 0.62);
        --radius: 14px;
        --shadow: 0 1px 2px rgba(0, 0, 0, 0.06), 0 10px 28px rgba(0, 0, 0, 0.07);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--text);
      }

      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 22px 16px 28px;
      }

      .header-card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px 16px 14px;
        margin-bottom: 14px;
      }

      .header-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 12px;
      }

      .header-title {
        margin: 0;
        font-size: 22px;
        letter-spacing: -0.01em;
        line-height: 1.15;
      }

      .header-subtitle {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .updated-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1;
        white-space: nowrap;
        background: rgba(0, 0, 0, 0.02);
      }

      .header-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .search-wrap {
        flex: 1 1 520px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #fff;
      }

      .search-icon {
        width: 16px;
        height: 16px;
        opacity: 0.55;
        flex: 0 0 auto;
      }

      #search {
        width: 100%;
        border: 0;
        outline: none;
        font-size: 14px;
        background: transparent;
        padding: 0;
        margin: 0;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        background: rgba(255, 255, 255, 0.7);
        white-space: nowrap;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        table-layout: fixed;
      }

      thead th {
        text-align: left;
        font-size: 12px;
        letter-spacing: 0.02em;
        color: rgba(0, 0, 0, 0.72);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        padding: 10px 10px;
        position: sticky;
        top: 0;
        background: rgba(255, 255, 255, 0.96);
        backdrop-filter: blur(6px);
        z-index: 1;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
      }

      thead th.num {
        text-align: right;
      }

      thead th .sort-ind {
        opacity: 0.5;
        margin-left: 6px;
        font-size: 11px;
      }

      tbody td {
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        padding: 9px 10px;
        font-size: 13px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      tbody tr:hover td {
        background: rgba(0, 0, 0, 0.02);
      }

      td.num {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }

      th.team-col,
      td.team {
        width: 260px;
      }

      th.record-col,
      td.record {
        width: 80px;
      }

      th.avg-col,
      td.avg {
        width: 180px;
      }

      th.ap-col,
      td.ap {
        width: 70px;
      }

      th.net-col,
      td.net {
        width: 70px;
      }

      th.kp-col,
      td.kp {
        width: 90px;
      }

      th.bpi-col,
      td.bpi {
        width: 70px;
      }

      th.sos-col,
      td.sos {
        width: 70px;
      }

      @media (max-width: 820px) {
        .header-top {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-controls {
          flex-direction: column;
          align-items: stretch;
        }
        .pill {
          align-self: flex-start;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header-card">
        <div class="header-top">
          <div style="min-width: 0">
            <h1 class="header-title">CBB Rankings Dashboard</h1>
            <div class="header-subtitle">Record • AVG • AP • NET • KenPom • BPI • SoS</div>
          </div>

          <div class="updated-pill">
            <span>Updated:</span>
            <span id="updated">—</span>
          </div>
        </div>

        <div class="header-controls">
          <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
              <path
                fill="currentColor"
                d="M10 4a6 6 0 1 1 0 12A6 6 0 0 1 10 4m0-2a8 8 0 1 0 4.9 14.3l4.4 4.4 1.4-1.4-4.4-4.4A8 8 0 0 0 10 2"
              />
            </svg>
            <input id="search" placeholder="Search team…" autocomplete="off" />
          </div>

          <div class="pill" id="count"></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th class="team-col" data-key="Team">Team<span class="sort-ind" data-ind="Team"></span></th>
            <th class="record-col" data-key="Record">Record<span class="sort-ind" data-ind="Record"></span></th>
            <th class="num avg-col" data-key="AVG">Avg of Net/KenPom/BPI<span class="sort-ind" data-ind="AVG"></span></th>
            <th class="num ap-col" data-key="AP">AP<span class="sort-ind" data-ind="AP"></span></th>
            <th class="num net-col" data-key="NET">NET<span class="sort-ind" data-ind="NET"></span></th>
            <th class="num kp-col" data-key="KenPom">KenPom<span class="sort-ind" data-ind="KenPom"></span></th>
            <th class="num bpi-col" data-key="BPI">BPI<span class="sort-ind" data-ind="BPI"></span></th>
            <th class="num sos-col" data-key="SoS">SoS<span class="sort-ind" data-ind="SoS"></span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <script>
      const asNum = (v) => {
        if (v === null || v === undefined) return null;
        const s = String(v).trim();
        if (!s || s.toLowerCase() === "nr" || s.toLowerCase() === "na") return null;
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      };

      const showRankOrNR = (v) => {
        const n = asNum(v);
        return n === null ? "NR" : String(n);
      };

      const computeAvgRank = (rows) => {
        const withAvg = rows.map((r) => {
          const net = asNum(r.NET);
          const kp = asNum(r.KenPom);
          const bpi = asNum(r.BPI);
          const ok = net !== null && kp !== null && bpi !== null;
          const avg = ok ? (net + kp + bpi) / 3 : null;
          return { ...r, _avg: avg };
        });

        const sorted = [...withAvg].sort((a, b) => {
          if (a._avg === null && b._avg === null) return 0;
          if (a._avg === null) return 1;
          if (b._avg === null) return -1;
          if (a._avg !== b._avg) return a._avg - b._avg;
          return String(a.Team).localeCompare(String(b.Team));
        });

        let rank = 0;
        let seen = 0;
        let last = null;

        const avgToRank = new Map();
        for (const r of sorted) {
          if (r._avg === null) continue;
          seen += 1;
          if (last === null || r._avg !== last) rank = seen;
          last = r._avg;
          avgToRank.set(r.Team, rank);
        }

        return withAvg.map((r) => ({
          ...r,
          AVG: avgToRank.has(r.Team) ? avgToRank.get(r.Team) : "NR",
        }));
      };

      const normalizeRowForSort = (r) => {
        const sos = r.SoS ?? r.SoSa ?? r.SOS ?? r.sos;
        return { ...r, SoS: sos };
      };

      const getSortValue = (row, key) => {
        const r = normalizeRowForSort(row);

        if (key === "AVG") {
          const v = r.AVG;
          const n = asNum(v);
          return n === null ? "NR" : n;
        }

        if (key === "SoS") {
          const n = asNum(r.SoS);
          return n === null ? "NR" : n;
        }

        if (key === "AP" || key === "NET" || key === "KenPom" || key === "BPI") {
          const n = asNum(r[key]);
          return n === null ? "NR" : n;
        }

        return String(r[key] ?? "");
      };

      const isNumericKey = (key) => {
        return key === "AVG" || key === "AP" || key === "NET" || key === "KenPom" || key === "BPI" || key === "SoS";
      };

      const compare = (a, b, key) => {
        const va = getSortValue(a, key);
        const vb = getSortValue(b, key);

        const aNR = va === "NR";
        const bNR = vb === "NR";
        if (aNR && bNR) return 0;
        if (aNR) return 1;
        if (bNR) return -1;

        if (isNumericKey(key)) {
          if (va !== vb) return va - vb;
          return String(a.Team ?? "").localeCompare(String(b.Team ?? ""));
        }

        const c = String(va).localeCompare(String(vb), undefined, { numeric: true, sensitivity: "base" });
        if (c !== 0) return c;
        return String(a.Team ?? "").localeCompare(String(b.Team ?? ""));
      };

      const render = (rows) => {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        for (const r of rows) {
          const sos = r.SoS ?? r.SoSa ?? r.SOS ?? r.sos;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="team">${r.Team ?? ""}</td>
            <td class="record">${r.Record ?? ""}</td>
            <td class="num avg">${r.AVG ?? "NR"}</td>
            <td class="num ap">${showRankOrNR(r.AP)}</td>
            <td class="num net">${showRankOrNR(r.NET)}</td>
            <td class="num kp">${showRankOrNR(r.KenPom)}</td>
            <td class="num bpi">${showRankOrNR(r.BPI)}</td>
            <td class="num sos">${showRankOrNR(sos)}</td>
          `;
          tbody.appendChild(tr);
        }

        document.getElementById("count").textContent = `${rows.length} teams`;
      };

      let allRows = [];
      let sortKey = "Team";
      let sortDir = "asc"; // asc | desc

      const applyFilterAndSort = () => {
        const q = document.getElementById("search").value.trim().toLowerCase();
        const filtered = !q
          ? [...allRows]
          : allRows.filter((r) => String(r.Team ?? "").toLowerCase().includes(q));

        filtered.sort((a, b) => compare(a, b, sortKey));
        if (sortDir === "desc") filtered.reverse();

        render(filtered);
        document.getElementById("count").textContent = `${filtered.length} teams`;

        document.querySelectorAll(".sort-ind").forEach((el) => (el.textContent = ""));
        const ind = document.querySelector(`.sort-ind[data-ind="${sortKey}"]`);
        if (ind) ind.textContent = sortDir === "asc" ? "▲" : "▼";
      };

      document.getElementById("search").addEventListener("input", applyFilterAndSort);

      document.querySelectorAll("thead th[data-key]").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (sortKey === key) sortDir = sortDir === "asc" ? "desc" : "asc";
          else {
            sortKey = key;
            sortDir = "asc";
          }
          applyFilterAndSort();
        });
      });

      fetch("data/rankings_current.json", { cache: "no-store" })
        .then((r) => r.json())
        .then((data) => {
          const updated = data.updated || data.last_updated || "—";
          document.getElementById("updated").textContent = updated;

          const rows = Array.isArray(data.rows) ? data.rows : [];
          allRows = computeAvgRank(rows);

          sortKey = "Team";
          sortDir = "asc";
          applyFilterAndSort();
        })
        .catch(() => {
          document.getElementById("updated").textContent = "(failed to load data)";
        });
    </script>
  </body>
</html>
